
把文件系统移植到 STM 32 上，将 flash 芯片格式化，使用 fat 文件系统。
不需要像前面用直接存储的方式存储数据，而是像电脑一样用文件的格式来存储数据。
## P 62 文件系统简介

#### 文件系统的概念
![[../../annex/串行Flash文件系统FatFs_image_1.png]]

![[../../annex/串行Flash文件系统FatFs_image_2.png]]
![[../../annex/串行Flash文件系统FatFs_image_3.png]]

##### 磁盘的物理结构
![[../../annex/串行Flash文件系统FatFs_image_4.png]]


![[../../annex/串行Flash文件系统FatFs_image_5.png]]

NTFS 文件系统没有那么多的碎片，支持单个文件超过 4 GB
以前的 FAT 格式的文件系统是不支持一个文件超过 4 GB 的

文件系统的好处：可以移植到不同的存储介质上（不需要管是什么底层硬件）

从 nand flash 复制一个文件到机械硬盘都是可以、兼容的。

![[../../annex/串行Flash文件系统FatFs_image_6.png]]


##### 磁盘分区表
![[../../annex/串行Flash文件系统FatFs_image_7.png]]

![[../../annex/串行Flash文件系统FatFs_image_8.png]]
逻辑地址->物理地址，然后进行存储


文件系统的意义：
1、包括存储介质上的管理系统
2、读取管理系统的代码

#### 文件系统是如何工作的？

##### 文件目录
![[../../annex/串行Flash文件系统FatFs_image_9.png|文件系统的空间示意图]]
簇，可以理解为是某个扇区

| 文件分配表 |  目录   |   A.TXT    |    B.TXT    |    C.TXT    |             |
|:----------:|:-------:|:----------:|:-----------:|:-----------:|:-----------:|
|  第 0 簇   | 第 1 簇 | 第 2~11 簇 | 第 12~65 簇 | 第 66~86 簇 | 第 87~99 簇 |

![[../../annex/串行Flash文件系统FatFs_image_10.png|目录示意图]]

![[../../annex/串行Flash文件系统FatFs_image_11.png]]

![[../../annex/串行Flash文件系统FatFs_image_12.png]]
开始地址被隐藏了，因为我们不需要知道

文件目录是记录了文件存储的扇区位置（某个文件存储在哪个扇区）

##### 文件分配表
![[../../annex/串行Flash文件系统FatFs_image_13.png|文件分配表]]

可能有文件是不连续的（不是连着 2~11 都是文件 A 的）
文件分配表是记录了这个扇区存储了哪一些内容，这个内容的下一部分在哪里。
文件分配表登记了某个文件的开头，以及它每个扇区之后的一个连续空间应该从哪里开始。

##### 空间示意图
![[../../annex/串行Flash文件系统FatFs_image_14.png]]
删除 B.TXT 文件后，磁盘的该部分空间就空余出来了。文件系统就会管理：这个空白空间可以写入新的数据，就把 D.TXT 写到这部分的空白空间。一直写到 65 簇，可能会发现空间不够用，（12~65 簇写完了不够，而 66 簇已经写了 C.TXT 了，不能把 C.TXT 的空间覆盖掉）。所以，在 C.TXT （找到新的空白空间）后写了 D.TXT 文件剩余的内容。

文件目录只表示一些连续的信息。文件分配表就专门用来处理这些不连续的空间。
![[../../annex/串行Flash文件系统FatFs_image_15.png]]
通过文件分配表就实现了一个连接

以什么格式来解读数据
在 windows 上用后缀名来区分


#### B 站 AI 视频总结

在嵌入式系统中使用串行 FAT 文件系统进行数据记录的方法。视频首先介绍了文件系统的概念和常用的 FAT 文件系统，然后讲解了如何将 FAT 文件系统移植到 STM 32 中进行实验。视频还介绍了如何使用文件系统进行数据记录，并提到了在使用文件系统时可能遇到的问题，如难以记录有效数据的位置、难以确定存储介质的剩余空间和不明确应该用什么格式来解读数据

串行 fresh 文件系统、嵌入式中常用的 f at fs 文件系统以及代码移植到 STM32的实验
00:01 文件系统概念与移植
02:26 存储数据的过程与格式转换
04:55 存储数据的位置与读取

如何管理存储空间、有效数据位置和数据格式等问题可以借鉴文件系统的思路。
06:20 数据解码问题: 如何解决数据解码问题，如何记录有效数据的位置。
09:32 文件系统: 文件系统的作用和实现方式，如何有效地管理存储空间。
10:32 硬盘和存储空间: 硬盘的类型和存储空间的管理方式，不同类型的存储空间的使用方法。

磁盘的物理结构和文件系统的作用, 以及不同文件系统的种类和使用。
10:45 文件系统和存储数据的方式
14:26 磁盘上的数据存储和管理
15:57 文件系统的作用和原理

文件系统的作用和移植方法以及在不同存储介质上的应用实现文件操作和管理功能。
16:24 文件系统的作用和移植方法
17:16 文件系统的存储介质: 各种存储介质的支持。
20:53 常见的文件系统: 常见的文件系统和其功能

硬盘格式化和文件系统的基本知识包括文件分配表和目录表的作用及读写过程
21:22 文件系统格式化: 讲解了不同文件系统格式的使用，以及在磁盘中建立文件的过程。
24:03 文件读取过程: 详细介绍了文件读取的过程包括目录表和磁盘分区表的作用。
25:08 分区表: 介绍了分区表的作用，以及在编程中如何使用分区表来管理文件系统。

文件系统的工作过程, 包括存储和读取文件时的逻辑地址转换为物理地址的过程
26:00 文件系统的存储过程: 在存储数据或文件时会先建立一个文件索引，然后写入新文件时会在索引里记录文件的物理地址，存储到目录里边。
30:24 解读文件系统: 文件系统的一些代码也叫做文件系统，它实际上是解读文件格式和数据的时候用到的代码。

文件系统的目录和文件分配表, 以及如何将逻辑地址转成物理地址, 存储文件等内容。
34:17 文件系统的目录和文件分配表
30:46 文件名和文件存储位置的关系
35:41 文件管理和权限控制

文件系统的目录和文件分配表的作用, 以及如何通过它们来管理磁盘上的文件。
36:11 文件系统中的目录和文件分配表
39:16 文件分配表的作用和结构
40:45 b.txt 文件的存储和读取过程

文件分配表的作用, 以及在处理不连续空间时的方法, 以实现文件系统的管理
41:00 文件分配表的作用和目录管理
44:53 处理不连续空间的方法和硬盘驱动器的结构
45:30 文件分配表的作用和硬盘驱动器组织

文件系统中的目录表和文件分配表的作用以及如何通过它们来读取文件。
45:41 文件系统的基本概念和结构，包括文件分配表和目录表的作用。
49:03 文件系统在存储介质上面的信息结构，以及如何通过目录表和文件分配表来获取数据。
50:20 建立文件系统的概念，如何存储数据到存储介质，以及数据在存储介质上如何映射。

地址的概念包括物理地址和地址的了解。下一节将介绍代码。
50:47 物理地址和数据传输
50:54 结束语

## P 63 FatFs 文件系统简介

![[../../annex/串行Flash文件系统FatFs_image_16.png|C语言中的文件操作]]
![[../../annex/串行Flash文件系统FatFs_image_17.png]]

STM 32 不能用上述的 C 语言文件操作，因为我们没有实现 C 语言的这些文件操作的一些接口（ windows 和 linux 系统本身已支持，所以可以直接使用）
我们需要自己重新实现 C 语言的这些函数，然后把它重定向到我们的 flash 芯片上，才能够事项对 flash 等进行读写。Stm 32 无法一直 windows 和 linux，所以就需要移植文件系统。

![[../../annex/串行Flash文件系统FatFs_image_18.png|FATFS文件系统简介]]
FATFS 文件系统的源码属于读取文件管理系统信息的代码

FATFS 文件系统的一个作用：
我们要对不同介质（flash、EEPROM、SD 卡等）进行读写的时候，我们都可以把 FATFS 文件系统移植到上面。然后使用 FATFS 文件系统以文件的格式去读写 flash 等介质。

FATFS 文件系统的好处：
占用空间小，所以就不考虑像以前一样把 C 语言标准函数 print 重定向到串口。文件系统就不重定向这些了。

FATXX 主要区别是文件容量大小（单个文件大小的最大空间，FAT 每个文件最大支持 2 GB、FAT 32 最大应该是支持 4 GB）

移植 FATFS 到 STM 32 上，然后再把 Flash 进行格式化，格式化后就能像电脑使用磁盘一样，在存储介质上建立文件，然后通过以文件格式的形式对 flash 进行存储/读取数据。

注意：不是说直接就支持这些存储介质，我们需要向 FATFS 的代码提供一些关于底层接口的函数，像 printf 重定向一样，需要我们底层自己实现的。


![[../../annex/串行Flash文件系统FatFs_image_19.png|FatFs源码目录结构]]

FATFS 文件系统帮我们实现了 fopen、fclose 以及这些 C 语言标准的一些函数。
![[../../annex/串行Flash文件系统FatFs_image_20.png]]

![[../../annex/串行Flash文件系统FatFs_image_21.png]]
但是它要求我们要自己实现一些函数。
主要是为了方便我们，如果想要对 EEPROM 进行读写的话，我们要返回 EEPROM 的状态，文件系统的上层某一些函数可能需要知道底层介质状态，就要调用 disk_status 函数，disk_status 就需要我们自己的 EEPROM 去实现。
![[../../annex/串行Flash文件系统FatFs_image_22.png]]

![[../../annex/串行Flash文件系统FatFs_image_23.png]]
又比如 f_write 函数可能最底层就需要调用 disk_write 函数，而 disk_write 函数就需要我们去实现对存储介质进行存储数据。


![[../../annex/Pasted image 20231206202717.png]]

![[../../annex/Pasted image 20231206202730.png]]

![[../../annex/Pasted image 20231206202829.png]]
打开 integer，内容是为了防止编译平台不一样（C 语言中，int 型 8051 芯片是 16 位的，在 stm 32 是 32 位的，通过这种格式定义就可以方便屏蔽编译器的差异）

Diskio.c 文件
![[../../annex/Pasted image 20231206203422.png]]
独立于底层介质的操作函数。移植 FATFS 文件系统的时候只需要改这个文件，然后给它提供各种接口。

ff.c 核心文件
![[../../annex/Pasted image 20231206203832.png]]
ff.c 实现了文件系统和底层的逻辑转换，而逻辑底层操作又封装成 diskio.c 等
这个文件实际上是把各种逻辑转换，转换之后得到了一个最底层的操作，就交给 diskio.c 文件里面的各种函数接口去操作。
![[../../annex/Pasted image 20231206204201.png]]
其实就属于 fatfs module（中间层），跟底层的操作就通过底层操作接口来对我们的存储介质进行操作

cc. 936 文件
![[../../annex/Pasted image 20231206204541.png]]
其实就是简体中文的编码页，通过 unicode 转 GB 2312 。Unicode 是国际通用的（包含全球字符的编码，转成像 ASCII 码一样的编码）编码。OEM 就是代码页。936 代表简体中文的代码页。
其实就是字符转换表。

![[../../annex/Pasted image 20231206213521.png]]

![[../../annex/Pasted image 20231206213602.png]]


#### B 站 AI 视频总结

文件系统的基本概念和代码表现形式，以 fat fs 文件系统为例，讲解了使用 c 语言的文件操作函数对存储介质里边存储的一些信息结构进行解读的方法。同时强调了这些操作是依赖于平台的，需要根据具体平台来实现。对于没有移植 Windows 和 Linux 的 STM 32 平台，需要自己重新实现 c 语言的文件操作函数并重定向到 fresh 芯片上

文件系统的基本概念和 fat 文件系统在存储介质上的表现, 以及文件系统代码的表现形式。
00:26 介绍了 fat 32 文件系统的代码表现形式，包括 fopen、fread、fwrite 等函数的使用。
01:43 打开文件: 讲解了如何使用 fopen 函数打开文件，并以读取模式打开文件。
05:06 操作文件: 介绍了如何使用 fread、fwrite 等函数对文件进行操作，并强调了在不同平台上函数的使用差异

如何移植文件系统并使用 f a t fs 文件系统实现对不同存储介质的读写操作。

06:27 实现读取文件系统: 介绍了如何通过编写代码实现对 Fresh 芯片或 SD 卡的读写操作。
08:40 Fatfs 文件系统: 详细介绍了 Fatfs 文件系统包括其作用、优点和使用方法。
11:38 读写操作: 提供了基本的读写操作函数，并说明了如何在 Fatfs 文件系统中使用。

Fatfs 文件系统该系统可以方便地对文件进行读写操作, 具有小巧易移植等特点。
12:18 文件系统操作: 介绍了如何使用 fatfs 文件系统进行文件的读写操作。
15:57 应用函数: 介绍了 fatfs 文件系统中的应用函数，包括 fopen、fread 等。
16:50 移植和使用: 介绍了如何移植和使用 fatfs 文件系统，并给出了相关代码。

文件系统层、底层设备控制层和存储介质之间的关系以及如何使用 API 实现文件操作
19:19 文件系统层: 把一个大问题分成小问题，实现文件系统的操作。
22:20 实现文件系统: 实现 fopen、fclose 等函数，要求自己实现，方便操作 rom。
23:47 读取数据: 使用 fread 函数，经过各种转换，最终调用到 diread 函数。

文件系统的读写操作和底层存储介质的访问, 以及相关的源代码和目录结构。
25:17 文件系统读写操作: 文件系统的读写操作，包括打开文件、读写数据、关闭文件等操作
25:51 文件系统代码介绍: 文件系统代码的目录结构和功能介绍，包括帮助文档和源代码。
29:28 文件作用和包含文件: 文件的作用和包含文件的概述，包括 integ. H、stm 32 f 10 x. H、stm 32 f 10 xdevice. H 等文件

如何使用一种格式定义来屏蔽编译器的差异, 以及如何实现底层驱动函数。
30:43 数据类型定义和驱动函数实现
34:14 存储介质初始化和数据读取
35:59 逻辑地址转换为物理地址

·ioct 和 fat time 等函数的作用以及 discio. H 和 f fc 文件的作用和实现方法。
36:31 文件系统相关函数和功能介绍
40:35 fatfs 文件系统及驱动开发
41:47 文件系统操作及注册文件观察器

文件系统中的 fatfs 文件系统的主体代码以及如何通过配置文件来裁剪代码。
42:15 文件系统的主体代码和配置文件
46:19 配置文件的作用和裁剪代码
47:54 移植文件系统的过程和注意事项

文件系统的各个文件和选项, 以及如何支持中文和英文介绍了代码页的概念和转换。
48:01 文件系统介绍: 文件系统的核心文件和选项文件，以及如何支持中文和英文
48:37 字符编码: Unicode 和 OEM 代码页的概念，以及如何使用 CC 936 和 932 文件支持中文和日文字符。
52:30 移植步骤: 如何阅读和理解源代码，以及移植的步骤和注意事项。

Fatfs 文件系统的分层结构和主要文件的作用, 以及如何进行移植和应用。
53:14 文件系统实现和使用: 推荐使用业界反映较好的免费文件系统。
57:21 移植文件系统可以方便编程和理解文件系统的来龙去脉。
57:54 总结和实践建议: 总结文件系统的作用，并提醒实践中要多思考和尝试。



## P 64 代码讲解-FatFs 文件系统移植


















#### B 站 AI 视频总结

如何将 f a t fs 文件系统的代码移植到 s t m32上，并利用这些代码对 fresh 进行读写和数据存储。通过对接 disk io.c 文件提供的函数接口，实现了对底层的操作，使文件系统的移植变得更加方便通用。同时，视频也详细介绍了如何添加文件系统中的文件和头文件，以及如何解决编译过程中出现的问题。最后，视频还提到了官方提供的范例程序，以及如何为其进行修改。















































































































