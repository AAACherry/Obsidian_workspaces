
## P 101  TIM-基本定时器-功能框图讲解

##### 定时器简介
定时器功能	：定时、输出比较、输入捕获、互补输出
定时器分类	：基本定时器、通用定时器、高级定时器
定时器资源	：F 103 系列有 2 个高级定时器 TIM 1 和 TIM 8、4 个通用定时器 TIM 2/3/4/5、2 个基本定时器 TIM 6 和 TIM7

输出比较：最常用的是外部 GPIO 输出 PWM 信号
输入捕获：可以测量一个信号的脉冲宽度/它的频率

##### 定时器分类

![[../../annex/21.TIM 定时器_image_1.png]]

##### 基本定时器功能框图讲解
###### 基本定时器功能简介
1-计数器 16 bit，只能向上计数，只有 TIM 6 和 TIM7
2-没有外部的 GPIO，是内部资源，只能用来定时
3-时钟来自 PCLK 1，为 72 M，可实现 1~65536 分频

我们知道，PCLK 1 初始化的时候配置 36 M，基本定时器的时钟来自 PCLK 1，而跟此处的 72 M 冲突了。
APB 1 是低速总线，分配系数是 2。因为系统时钟 AHB 是 72 M，二分频后就等于 36 M。
要乘以 2，所以说并不是跟 APB 1 的总线时钟矛盾。

![[../../annex/21.TIM 定时器_image_2.png]]

APB 2 总线是高速总线，默认配置成 1 分频
![[../../annex/21.TIM 定时器_image_3.png]]

![[../../annex/21.TIM 定时器_image_4.png]]
所以得到定时器 1 和 8 的时候是 72 M


![[../../annex/21.TIM 定时器_image_5.png]]

![[../../annex/21.TIM 定时器_image_6.png]]


###### 时钟源
1-时钟源来自 RCC 的 TIMx_CLK（属于内部的 CK_INT）
2-TIMx_CLK 等于多少呢？如何确定？（72 M）
具体的查看：RCC 时钟树框图

###### 控制器
1-控制器用于控制定时器的：复位、使能、计数、触发 DAC
2、涉及到的寄存器为：CR 1/2、DIER、EGR、SR

###### 时基（定时器的心脏）
定时器最主要的就是时基部分：包括<font color="#ff0000">预分频器</font>（PSC，用来对时间进行分频的）、<font color="#ff0000">计数器</font>（CNT，count）、<font color="#ff0000">自动重装载寄存器</font>（ARR）。

计数要在时钟的驱动下进行计数，时钟是方波，一个脉冲计数器就加 1。
![[../../annex/Pasted image 20240126231715.png]]
驱动计数器的时钟叫 CK_CNT，是由 CK_PSC （内部时钟，72 M）经过预分频器 PSC 得到的

###### 预分频器
1-16 位（最大 65535）的预分频器 PSC 对内部时钟 CK_PSC 进行分频之后，得到计数器时钟 <font color="#ff0000">CK_CNT=CK_PSC/(PSC+1)</font>.（PSC+1 是官方规定的，必须加 1）

2-计数器 CNT 在计数器时钟的驱动下开始计数，计数一次的时间为 1/CK_CNT
计数周期： 1/CK_CNT x （ARR+1）--是从 0 计数到 ARR，实际计数了 ARR+1 次

###### 计数器、自动重装载寄存器
定时器使能 (CEN 置 1)后，计数器 CNT 在 CK_CNT 驱动下计数，当 TCNT 值与 ARR 的设定值相等时就自动生成事件并 CNT 自动清零，然后自动重新开始计数，如此重复以上过程。

自动重装载寄存器（ARR）表示计数器能够计数到的最大数值。
如：配置成 1000 时，计数器从 0 计数到 1000 时，产生中断，计数器清零，重新自动装载。

###### 影子寄存器
1-PSC 和 ARR 都有影子寄存器，功能框图上有个影子
2-影子寄存器的存在起到一个<font color="#ff0000">缓冲的作用</font>，用户值->寄存器->影子寄存器->起作用，如果不使用影子寄存器则用户值在写到寄存器之后则里面起作用。
<font color="#ff0000">ARR 影子，TIMx_CR 1: APRE 位控制</font>.（由控制寄存器 1--TIMx_CR 1 的第 7 位来控制）
（计数器在这个周期计数完毕后，即产生一个更新中断后在下一个周期开始的时候我们写进去的 ARR 的值才起作用）通常情况下设置立马起作用

###### 定时时间的计算
<font color="#ff0000">如何实现 500 mS 的定时</font>？

```
1、PSC = 72-1，定时器频率=72 M/(PSC+1)=1 MHZ
2、ARR = 1000-1，从 0 计数到 999，则计了 1000 次
3、中断周期 T = 1000 *1/1000000 = 1 mS
```
<font color="#ff0000">定时器频率=72 M/(PSC+1)=1 MHZ</font>.

由此可见，想控制一次中断产生的时间，都需要控制 PSC 和 ARR 的值

##### 时基初始化结构体讲解

![[../../annex/tmp1706282236840_21.TIM 定时器_image_7.png]]

[2024-01-26 23：30：19]



## P 102  TIM-基本定时器-定时代码讲解

##### 代码

```main.c
#include "stm32f10x.h"  //相当于51单片机中的    #include <reg51.h> 
#include "bsp_led.h"
#include "bsp_BasicTim.h"

uint16_t time = 0;
//在it.c中使用了，在it.c中声明一下


int main(void)
{
  //  来到这里的时候,系统的时钟已经被配置成72M。不需要自己配置，启动文件中已经配置好了。
	LED_GPIO_Config();//初始化LED端口

	BASIC_TIM_Init();//初始化完毕，这时候定时器就开始工作了，如果时间到了，定时器会进入中断，让time的值++
	
	//然后我们不断的判断time的值是否等于1000
	while(1)
	{
		if( time == 1000 )//1000ms(1s)
		{
			time = 0;
			LED1_TOGGLE;/* LED1 取反 */
		}	
			
	}
}




```

```bsp_BasicTim.c
#include "bsp_BasicTim.h"

//往初始化结构体中每个成员写配数据，然后调用init函数，就会把我们配置好的结构体成员写到相应的寄存器中


// 中断优先级配置
static void BASIC_TIM_NVIC_Config(void)
{
    NVIC_InitTypeDef NVIC_InitStructure; 
    // 设置中断组为0
    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_0);		
		// 设置中断来源
    NVIC_InitStructure.NVIC_IRQChannel = BASIC_TIM_IRQ ;	
		// 设置主优先级为 0
    NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;	 
	  // 设置抢占优先级为3
    NVIC_InitStructure.NVIC_IRQChannelSubPriority = 3;//只有1个中断源，随便配置	
    NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    NVIC_Init(&NVIC_InitStructure);
}


static void BASIC_TIM_Config(void)//static,限定函数内部调用,其他文件调用不了
{
	
    TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure;//首先，定义一个初始化结构体。然后往结构体中填充成员
		
		// 开启定时器时钟,即内部时钟CK_INT=72M
    BASIC_TIM_APBxClock_FUN(BASIC_TIM_CLK, ENABLE);//先开定时器的时钟
	
		// 自动重装载寄存器的值，累计TIM_Period+1个频率后产生一个更新或者中断
    TIM_TimeBaseStructure.TIM_Period = BASIC_TIM_Period;	

	  // 时钟预分频数为
    TIM_TimeBaseStructure.TIM_Prescaler= BASIC_TIM_Prescaler;//配置的是1us
	
		// 时钟分频因子 ，基本定时器没有，不用管
    //TIM_TimeBaseStructure.TIM_ClockDivision=TIM_CKD_DIV1;
		
		// 计数器计数模式，基本定时器只能向上计数，没有计数模式的设置
    //TIM_TimeBaseStructure.TIM_CounterMode=TIM_CounterMode_Up; 
		
		// 重复计数器的值，基本定时器没有，不用管
		//TIM_TimeBaseStructure.TIM_RepetitionCounter=0;
	
	  // 初始化定时器
    TIM_TimeBaseInit(BASIC_TIM, &TIM_TimeBaseStructure);
		
		// 清除计数器中断标志位
    TIM_ClearFlag(BASIC_TIM, TIM_FLAG_Update);
	  
		// 开启计数器中断
    TIM_ITConfig(BASIC_TIM,TIM_IT_Update,ENABLE);
		
		// 使能计数器
    TIM_Cmd(BASIC_TIM, ENABLE);	
	
	
}

void BASIC_TIM_Init(void)
{
	BASIC_TIM_NVIC_Config();//首先，配置好中断优先级
	BASIC_TIM_Config();//再调用模式配置
}


```

```bsp_BasicTim.h
#ifndef __BSP_TIMEBASE_H
#define __BSP_TIMEBASE_H


#include "stm32f10x.h"

/********************基本定时器TIM参数定义，只限TIM6、7************/
#define BASIC_TIM6 // 如果使用TIM7，注释掉这个宏即可

#ifdef  BASIC_TIM6 // 使用基本定时器TIM6
#define            BASIC_TIM                   TIM6
#define            BASIC_TIM_APBxClock_FUN     RCC_APB1PeriphClockCmd //2、3、4、5、6、7挂载在APB1总线
#define            BASIC_TIM_CLK               RCC_APB1Periph_TIM6
#define            BASIC_TIM_Period            1000-1
#define            BASIC_TIM_Prescaler         71
#define            BASIC_TIM_IRQ               TIM6_IRQn
#define            BASIC_TIM_IRQHandler        TIM6_IRQHandler

#else  // 使用基本定时器TIM7
#define            BASIC_TIM                   TIM7
#define            BASIC_TIM_APBxClock_FUN     RCC_APB1PeriphClockCmd
#define            BASIC_TIM_CLK               RCC_APB1Periph_TIM7
#define            BASIC_TIM_Period            1000-1
#define            BASIC_TIM_Prescaler         71
#define            BASIC_TIM_IRQ               TIM7_IRQn
#define            BASIC_TIM_IRQHandler        TIM7_IRQHandler

#endif
/**************************函数声明********************************/


void BASIC_TIM_Init(void);




#endif	/* __BSP_TIMEBASE_H */


```

```stm32f10x_it.c
#include "bsp_BasicTim.h"

extern uint16_t time;//extern，表示变量是外部定义的

void  BASIC_TIM_IRQHandler (void)
{
	if ( TIM_GetITStatus( BASIC_TIM, TIM_IT_Update) != RESET ) 
	{	
		time++;//time应该为全局变量，main函数中定义
		TIM_ClearITPendingBit(BASIC_TIM , TIM_FLAG_Update);  		 
	}		 	
}
```

```
```


[2024-01-27 00：39：27]

```
在bsp_BasicTim.h文件中声明函数void BASIC_TIM_Init(void);时忘记加分号了，导致6个error报错
```




## P 103 TIM-高级定时器-时钟源功能框图讲解














































































































































































































































































































































































