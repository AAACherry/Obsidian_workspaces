
## P 101 TIM-功能框图讲解

##### 定时器简介
定时器功能	：定时、输出比较、输入捕获、互补输出
定时器分类	：基本定时器、通用定时器、高级定时器
定时器资源	：F 103 系列有 2 个高级定时器 TIM 1 和 TIM 8、4 个通用定时器 TIM 2/3/4/5、2 个基本定时器 TIM 6 和 TIM7

输出比较：最常用的是外部 GPIO 输出 PWM 信号
输入捕获：可以测量一个信号的脉冲宽度/它的频率

##### 定时器分类

![[../../annex/21.TIM 定时器_image_1.png]]

##### 基本定时器功能框图讲解
###### 基本定时器功能简介
1-计数器 16 bit，只能向上计数，只有 TIM 6 和 TIM7
2-没有外部的 GPIO，是内部资源，只能用来定时
3-时钟来自 PCLK 1，为 72 M，可实现 1~65536 分频

我们知道，PCLK 1 初始化的时候配置 36 M，基本定时器的时钟来自 PCLK 1，而跟此处的 72 M 冲突了。
APB 1 是低速总线，分配系数是 2。因为系统时钟 AHB 是 72 M，二分频后就等于 36 M。
要乘以 2，所以说并不是跟 APB 1 的总线时钟矛盾。

![[../../annex/21.TIM 定时器_image_2.png]]

APB 2 总线是高速总线，默认配置成 1 分频
![[../../annex/21.TIM 定时器_image_3.png]]

![[../../annex/21.TIM 定时器_image_4.png]]
所以得到定时器 1 和 8 的时候是 72 M


![[../../annex/21.TIM 定时器_image_5.png]]

![[../../annex/21.TIM 定时器_image_6.png]]


###### 时钟源
1-时钟源来自 RCC 的 TIMx_CLK（属于内部的 CK_INT）
2-TIMx_CLK 等于多少呢？如何确定？（72 M）
具体的查看：RCC 时钟树框图

###### 控制器
1-控制器用于控制定时器的：复位、使能、计数、触发 DAC
2、涉及到的寄存器为：CR 1/2、DIER、EGR、SR

###### 时基（定时器的心脏）
定时器最主要的就是时基部分：包括<font color="#ff0000">预分频器</font>（PSC，用来对时间进行分频的）、<font color="#ff0000">计数器</font>（CNT，count）、<font color="#ff0000">自动重装载寄存器</font>（ARR）。

计数要在时钟的驱动下进行计数，时钟是方波，一个脉冲计数器就加 1。
![[../../annex/Pasted image 20240126231715.png]]
驱动计数器的时钟叫 CK_CNT，是由 CK_PSC （内部时钟，72 M）经过预分频器 PSC 得到的

###### 预分频器
1-16 位（最大 65535）的预分频器 PSC 对内部时钟 CK_PSC 进行分频之后，得到计数器时钟 <font color="#ff0000">CK_CNT=CK_PSC/(PSC+1)</font>.（PSC+1 是官方规定的，必须加 1）

2-计数器 CNT 在计数器时钟的驱动下开始计数，计数一次的时间为 1/CK_CNT
计数周期： 1/CK_CNT x （ARR+1）--是从 0 计数到 ARR，实际计数了 ARR+1 次

###### 计数器、自动重装载寄存器
定时器使能 (CEN 置 1)后，计数器 CNT 在 CK_CNT 驱动下计数，当 TCNT 值与 ARR 的设定值相等时就自动生成事件并 CNT 自动清零，然后自动重新开始计数，如此重复以上过程。

自动重装载寄存器（ARR）表示计数器能够计数到的最大数值。
如：配置成 1000 时，计数器从 0 计数到 1000 时，产生中断，计数器清零，重新自动装载。

###### 影子寄存器
1-PSC 和 ARR 都有影子寄存器，功能框图上有个影子
2-影子寄存器的存在起到一个<font color="#ff0000">缓冲的作用</font>，用户值->寄存器->影子寄存器->起作用，如果不使用影子寄存器则用户值在写到寄存器之后则里面起作用。
<font color="#ff0000">ARR 影子，TIMx_CR 1: APRE 位控制</font>.（由控制寄存器 1--TIMx_CR 1 的第 7 位来控制）
（计数器在这个周期计数完毕后，即产生一个更新中断后在下一个周期开始的时候我们写进去的 ARR 的值才起作用）通常情况下设置立马起作用

###### 定时时间的计算
<font color="#ff0000">如何实现 500 mS 的定时</font>？

```
1、PSC = 72-1，定时器频率=72 M/(PSC+1)=1 MHZ
2、ARR = 1000-1，从 0 计数到 999，则计了 1000 次
3、中断周期 T = 1000 *1/1000000 = 1 mS
```
<font color="#ff0000">定时器频率=72 M/(PSC+1)=1 MHZ</font>.

由此可见，想控制一次中断产生的时间，都需要控制 PSC 和 ARR 的值

##### 时基初始化结构体讲解

![[../../annex/tmp1706282236840_21.TIM 定时器_image_7.png]]

[2024-01-26 23：30：19]



## P 102 定时代码讲解



























































































































































































































































































































































































