
## P 55 SPI 协议介绍

### SPI 协议简介

IIC 是比较低速的，SPI 是高速的。
![[../../annex/SPI--读写串行FLASH_image_1.png]]
SPI 是全双工（可以同时接收和发送）的通信总线。用于板级（芯片）之间通讯较多。要求通讯速率较高的场合。（SPI 支持 25 M，45 M 等都有，本身 SPI 协议没有限制，但是受限于硬件设备）
IIC 是半双工的。最高时钟是 3.4 MHz（但是很多 IIC 的设备都最高只支持到 400 kHz）

#### SPI 物理层特点

![[../../annex/SPI--读写串行FLASH_image_2.png]]
实际上 SPI 设备只有 4 根线。
一般来说叫 CS 引脚（芯片/从设备选择信号线，也称为片选信号线），每个从设备都会有一根 CS 信号线独立接到主机的一个引脚。其他的线是公用的。

不是通过数据线来广播地址，而是通过每个设备独立的片选信号线来选择设备，片选信号线设为低电平就代表着该设备被选中，即 CS 线是用来区分各个从机的。作用：可以用来防止干扰，选中某个设备。

调为高电平就相当于意味结束信号。SPI 中直接用 CS 线拉低代表通讯的开始，CS 线由低电平变为高电平视为通讯的结束。


其他三根线的作用：SCK、MOSI、MISO
![[../../annex/SPI--读写串行FLASH_image_3.png]]
SCK （serial clock）线：时钟信号线，用于通讯数据同步。（使用时钟信号线来实现数据同步）
在 SCK 线的协调下，就规定了数据的有效性。
SPI 跟 IIC 不同，IIC 是在 SCK 的高电平下被采集。SPI 比较复杂，在边缘采样。既可能是高电平采样，也可能是低电平采样。
APB 1 总线的时钟就叫 PCLK 1，APB 2 总线的时钟就叫 PCLK 2。
STM 32 的 SPI 时钟频率最大为 f<sub>pclk</sub>÷2，通讯受限于低速设备。


![[../../annex/SPI--读写串行FLASH_image_4.png]]
MOSI 和 MISO 作为传输数据的。一根接收，一根发送，所以支持全双工。
MOSI 和 MISO 是 SPI 协议中专用的数据通讯（传输数据）的引脚。
MOSI（master output，slave input）：主设备输出/从设备输入引脚。
MISO（master input，slave output）：主设备输入/从设备输出引脚。

MOSI 和 MISO 也是串行的数据线。在一个时钟的协调下，只能传输一个数据位的信号。（传输一个字节就像 IIC 一样，传输完 8 个时钟就可以传输一个字节了）。

由于 MOSI 和 MISO 是同时在时钟线是同步的，在同样的时钟协调下，在发送数据的同时也可以接受数据，（MOSI 发送数据，MISO 接收数据）。


#### SPI 协议层

![[../../annex/SPI--读写串行FLASH_image_5.png]]
以主机为视角。
这里的触发代表数据变化，MOSI 和 MISO 是不稳定的，这个时候是不会采样的。
在采样过程中，数据都是稳定的，在这个时候 MOSI 和 MISO 所表达的数据（所表达的电平信号）就代表了一个数据位的数据。只要经过 8 个时钟，就能够把数据传输出去了。
MSBOUT 和 LSBOUT 串行通讯的时候，代表着高位字节先行还是低位字节先行。大多是规定是高位字节先行。
并不是规定了上升沿就变化，下降沿就采集，还需要配置的。

![[../../annex/SPI--读写串行FLASH_image_6.png]]

![[../../annex/SPI--读写串行FLASH_image_7.png]]

CPHA = 0 时。（图中绿色部分进行数据采样）奇数边沿采样
![[../../annex/SPI--读写串行FLASH_image_8.png]]
时钟极性 CPOL、时钟相位 CPHA 配置 SPI 协议是在哪个边缘触发或采样的。
时钟极性 CPOL：指 SPI 通讯设备处于空闲状态时，SCK 信号线的电平信号。（CS 信号线为高电平的时候就是空闲状态，在通讯开始之前，此时的 SCK 引脚的电平就表示时钟极性）
SCK 在空闲状态是低电平时，CPOL = 0，就说是时钟极性为 0。
SCK 在空闲状态是高电平时，CPOL = 1，就说是时钟极性为 1。

时钟相位 CPHA：指数据的采样时刻。
当 CPHA = 0 时，MOSI 或 MISO 数据线上的信号将会在 SCK 时钟线的 “奇数边沿” 被采样。
当 CPHA = 1 时，MOSI 或 MISO 数据线上的信号将会在 SCK 时钟线的 “偶数边沿” 被采样。
边沿是指上升沿/下降沿。

CPOL 时钟极性和 CPHA 时钟相位 配合才能确认到底是上升沿还是下降沿。

CPHA = 1 时。（图中绿色部分进行数据采样）偶数边沿采样
![[../../annex/SPI--读写串行FLASH_image_9.png]]

此处，16 个时钟边沿，即 8 个时钟，所以说传输的是 8 个数据位（不是硬性规定）。

#### 总结
![[../../annex/SPI--读写串行FLASH_image_10.png]]
CPOL 时钟极性和 CPHA 时钟相位：相同上升沿、相异下降沿。



## P 56 SPI 框图及通讯过程

![[../../annex/SPI--读写串行FLASH_image_11.png]]

![[../../annex/SPI--读写串行FLASH_image_12.png]]
SPI 1 挂载在 APB 2 上，最大时钟频率位 36 MHz。
SPI 2 等挂载在 APB 1 上，最大时钟频率为 18 MHz。

STM32F10X 的数据帧长度为 8 位或 16 位，即一次传输的数据位。
可以设置高位先行还是低位先行，支持双线全双工。可以进行双线单向传输（提高传输速率），单线传输（节省数据线）

![[../../annex/SPI--读写串行FLASH_image_13.png]]
波特率发生器，控制 SCK 引脚，产生时钟输出。SPI 协议也是只有主机才能够产生时钟，所以波特率发生器就是 STM 32 作为主机的时候使用的。作为从机，波特率发生器就从外面接收时钟，作为主机就对外发送时钟。
跟 IIC 类似，数据接收进来后，都是通过移位寄存器进行数据的传输发送。
整体控制逻辑：
CR 寄存器（control 控制寄存器，CR 2 是配置 DMA 等有关的），
SR 寄存器（status 状态寄存器），
BR 寄存器（控制波特率），
CRL 寄存器（CRL 1 和 CRL 2 分别配置不同的功能）.

![[../../annex/SPI--读写串行FLASH_image_14.png]]

SPI 3 所用的引脚用在了 SWDK 下载接口。（引脚是复用的）用起来会比较麻烦。所以下载程序的时候可能要按着复位键，然后再点 SMDK 下载按钮才能够把程序下载进去。
就是说，让芯片处于复位状态，它就不会占用这个 SPI 3 引脚而导致下载不进去。








































































































